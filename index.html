<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Communes visitées en Belgique</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100%; }
    .legend {
      position: absolute; bottom: 16px; left: 16px;
      background: white; padding: 10px 12px; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.1); font: 14px/1.3 Arial, sans-serif;
    }
    .legend .row { display: flex; align-items: center; margin: 4px 0; }
    .legend .swatch { width: 14px; height: 14px; margin-right: 8px; border: 1px solid #888; }
    .leaflet-container a { color: #1d72b8; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend" id="legend">
    <div class="row"><span class="swatch" style="background:#2ecc71"></span>Visité</div>
    <div class="row"><span class="swatch" style="background:#e74c3c"></span>Non visité</div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- PapaParse pour lire le CSV Notion côté navigateur -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // Petite fonction utilitaire : met en minuscules et enlève les accents/espaces superflus
    function normalizeName(name) {
      return (name || "")
        .toString()
        .normalize("NFD").replace(/\p{Diacritic}/gu, "")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();
    }

    // Probables clés de nom de commune dans le GeoJSON (on essaie dans cet ordre)
    const NAME_FIELDS = [
      "name", "name_fr", "nom", "commune", "municipality", "gemeente",
      "naam", "NAAM", "NAME_2", "name_nl", "name_de"
    ];

    const map = L.map('map', { preferCanvas: true }).setView([50.5, 4.5], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // 1) Charger le CSV Notion => dictionnaire { nom_normalise: { visited: true/false, date: ... } }
    function loadVisitedCSV() {
      return fetch('visited.csv')
        .then(r => r.text())
        .then(text => {
          const result = Papa.parse(text, { header: true, skipEmptyLines: true, delimiter: ";" });
          const visitedMap = {};
          result.data.forEach(row => {
            const rawName = row["Commune"] || row["commune"] || row["Municipality"] || row["Gemeente"];
            const rawVisited = row["Visitee"] ?? row["Visité"] ?? row["Visited"];
            const rawDate = row["Date"] ?? row["date"] ?? "";

            if (!rawName) return;
            const key = normalizeName(rawName);
            const v = String(rawVisited ?? "").toLowerCase().trim();
            const isVisited = (v === "oui" || v === "yes" || v === "true" || v === "1" || v === "x");

            visitedMap[key] = { visited: isVisited, date: rawDate };
          });
          return visitedMap;
        });
    }

    // 2) Charger le GeoJSON des communes et dessiner
    Promise.all([
      loadVisitedCSV(),
      fetch('belgium-communes.geojson').then(r => r.json())
    ]).then(([visited, geo]) => {
      const layer = L.geoJSON(geo, {
        style: feature => {
          const props = feature.properties || {};
          let name = "";
          for (const f of NAME_FIELDS) {
            if (props[f] != null) { name = String(props[f]); break; }
          }
          const key = normalizeName(name);
          const isVisited = visited[key]?.visited || false;
          return {
            color: "#555",
            weight: 0.8,
            fillColor: isVisited ? "#2ecc71" : "#e74c3c",
            fillOpacity: 0.7
          };
        },
        onEachFeature: (feature, layer) => {
          let name = "";
          const props = feature.properties || {};
          for (const f of NAME_FIELDS) {
            if (props[f] != null) { name = String(props[f]); break; }
          }
          const key = normalizeName(name);
          const data = visited[key] || { visited: false, date: "" };

          let popup = `<b>${name || "Commune"}</b><br>`;
          popup += data.visited ? "✅ Visité" : "❌ Non visité";
          if (data.date) popup += `<br>Date : ${data.date}`;

          layer.bindPopup(popup);
          layer.on('mouseover', () => layer.setStyle({ weight: 2 }));
          layer.on('mouseout', () => layer.setStyle({ weight: 0.8 }));
        }
      }).addTo(map);

      try { map.fitBounds(layer.getBounds(), { padding: [10, 10] }); } catch (e) {}
    }).catch(err => {
      console.error(err);
      alert("Erreur de chargement des données. Vérifie les fichiers 'visited.csv' et 'belgium-communes.geojson'.");
    });
  </script>
</body>
</html>
