<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Carte — Communes Belgique</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  html,body { height:100%; margin:0; }
  #map { width:100%; height:100vh; }
  .legend { background:white; padding:6px 8px; font-family:sans-serif; font-size:13px; border-radius:4px; box-shadow:0 1px 3px rgba(0,0,0,0.2); }
  .legend .box { display:inline-block; width:14px; height:14px; margin-right:6px; vertical-align:middle; border:1px solid #222; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* --- CONFIG --- */
const GEOJSON_FILE = 'communes.geojson';
const VISITED_CSV = 'visited.csv';
/* ------------- */

function normalizeName(s) {
  if (!s) return '';
  return String(s)
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')   // enlever accents
    .replace(/[^a-z0-9 ]/gi, '')                       // enlever ponctuation
    .toLowerCase()
    .trim();
}

function findNameKey(props) {
  const candidates = ['NAMENL','NAME_NL','NAME_FR','NAME','NOM','NOM_COMMUNE','COMMUNE','GEMEENTE','gemeente','naam','nom','label'];
  for (const c of candidates) if (props[c]) return c;
  for (const k in props) {
    if (typeof props[k] === 'string' && props[k].length>0) return k;
  }
  return null;
}

const map = L.map('map').setView([50.85,4.35], 8);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap contributors' }).addTo(map);

Promise.all([
  fetch(GEOJSON_FILE).then(r => r.json()),
  fetch(VISITED_CSV).then(r => r.text())
]).then(([geojson, csvText]) => {
  // Parse CSV (on cherche automatiquement la colonne de noms)
  const parsed = Papa.parse(csvText.trim(), { header:true, skipEmptyLines:true });
  const visited = new Set();
  if (parsed && parsed.data && parsed.meta && parsed.meta.fields && parsed.meta.fields.length>0) {
    const headers = parsed.meta.fields;
    let col = headers.find(h => /commune|nom|name|gemeente|naam/i.test(h)) || headers[0];
    for (const row of parsed.data) {
      if (row[col] && row[col].trim()) visited.add(normalizeName(row[col]));
      else {
        // fallback : tenter toutes les valeurs
        for (const v of Object.values(row)) if (v && String(v).trim()) visited.add(normalizeName(v));
      }
    }
  } else {
    // simple list sans header
    csvText.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean).forEach(s=>visited.add(normalizeName(s)));
  }

  // trouver la clé contenant le nom de la commune dans le GeoJSON
  let nameKey = null;
  for (const f of geojson.features) {
    nameKey = findNameKey(f.properties);
    if (nameKey) break;
  }
  if (!nameKey && geojson.features.length>0) nameKey = Object.keys(geojson.features[0].properties)[0];

  // Layer GeoJSON
  let geojsonLayer;
  function styleFeature(feature) {
    const rawName = feature.properties[nameKey] || '';
    const isVisited = visited.has(normalizeName(rawName));
    return {
      color: '#222',
      weight: 0.4,
      fillColor: isVisited ? '#999' : '#ffffff',
      fillOpacity: isVisited ? 0.7 : 0.3
    };
  }
  function onEachFeature(feature, layer) {
    const rawName = feature.properties[nameKey] || '—';
    const isVisited = visited.has(normalizeName(rawName));
    layer.bindTooltip(`<strong>${rawName}</strong><br/>${isVisited ? 'Visité' : 'Non visité'}`, {sticky:true});
    layer.on({
      mouseover: e => e.target.setStyle({ weight:1.6 }),
      mouseout:  e => { if (geojsonLayer) geojsonLayer.resetStyle(e.target); }
    });
  }

  geojsonLayer = L.geoJSON(geojson, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
  if (geojsonLayer.getBounds().isValid()) map.fitBounds(geojsonLayer.getBounds());

  // Légende
  const legend = L.control({position:'bottomright'});
  legend.onAdd = function() {
    const div = L.DomUtil.create('div','legend');
    div.innerHTML = '<div><span class="box" style="background:#999"></span> Visité</div>'
                  + '<div><span class="box" style="background:#fff"></span> Non visité</div>';
    return div;
  };
  legend.addTo(map);

}).catch(err => {
  console.error(err);
  alert('Erreur: impossible de charger les fichiers. Vérifie que communes.geojson et visited.csv sont au même niveau que index.html.');
});
</script>
</body>
</html>
